name: Pull-Request Auto-Deploy

on:
  push:
    branches:
      - 'auto-*'

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Branch Name
        run: echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV

      - name: Create Pull Request via GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d "{
              \"title\": \"[AUTO] PR from $BRANCH_NAME to main\",
              \"head\": \"$BRANCH_NAME\",
              \"base\": \"main\",
              \"body\": \"This PR is auto-generated from $BRANCH_NAME to main.\"
            }")
          echo "$PR_RESPONSE"
          PR_NUMBER=$(echo "$PR_RESPONSE" | jq .number)
          if [ "$PR_NUMBER" == "null" ]; then
            echo "Error creating PR"
            exit 1
          else
            echo "PR created successfully: #$PR_NUMBER"
            echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          fi
