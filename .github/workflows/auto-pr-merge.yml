name: Auto PR + Approve + Auto-merge (simple)

on:
  push:
    branches: [ "auto-*" ]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto_pr_and_merge:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set branch name
        run: echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV

      # 1) Create or reuse PR (author = github-actions[bot])
      - name: Create or reuse PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          CREATE=$(curl -s -w "\n%{http_code}\n" -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls" \
            -d "{\"title\":\"[AUTO] $BRANCH_NAME â†’ main\",\"head\":\"$BRANCH_NAME\",\"base\":\"main\",\"body\":\"Auto-generated from '$BRANCH_NAME' to main.\"}")
          BODY=$(echo "$CREATE" | sed '$d'); CODE=$(echo "$CREATE" | tail -n1)
          if [ "$CODE" = "201" ]; then
            PR_NUMBER=$(echo "$BODY" | jq -r .number)
          else
            PR_NUMBER=$(curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&head=${{ github.repository_owner }}:$BRANCH_NAME&base=main" \
              | jq -r '.[0].number')
            [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ] && { echo "::error::Could not create/find PR (HTTP $CODE)"; exit 1; }
          fi
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "âœ… PR #$PR_NUMBER ready"

      # 2) Approve (must be a different user than PR author)
      - name: Approve PR
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: gh pr review $PR_NUMBER --repo "${{ github.repository }}" --approve

      # 3) Enable auto-merge (merges after checks pass) + delete branch
      - name: Enable Auto-merge
        env:
          GH_TOKEN: ${{ secrets.BOT_PAT }}
        run: gh pr merge $PR_NUMBER --repo "${{ github.repository }}" --auto --squash --delete-branch

      - name: Done
        run: echo "ðŸŽ‰ All set."
